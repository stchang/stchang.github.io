import * as $rjs_core from '../../../../runtime/core.js';import * as M0 from "../../../../runtime/kernel.rkt.js";import * as M1 from "../../../racketscript-compiler/racketscript/interop.rkt.js";import * as M2 from "../private/jscommon.rkt.js";import * as M3 from "../../../racketscript-compiler/racketscript/private/interop.rkt.js";var __times_default_frames_per_second_times_ = 70;var make_big_bang = function(init_world949, handlers950) {return new BigBang(init_world949,handlers950);};var big_bang = $rjs_core.attachProcedureArity(function(init_world951, ...handlers9521469) {var handlers952 = $rjs_core.Pair.listFromArray(handlers9521469);return make_big_bang(init_world951,handlers952).setup().start();});var BigBang = function(init_world953, handlers954) {var this955 = this;this955.world = init_world953;this955.interval = 1000/__times_default_frames_per_second_times_;this955.handlers = handlers954;this955.__active_handlers = {};this955.__world_change_listeners = [];this955.__idle = true;this955.__stopped = true;this955.__events = [];return null;};BigBang.prototype.setup = function() {var this956 = this;var canvas957 = M2.document.createElement("canvas");var ctx958 = canvas957.getContext("2d");canvas957.setAttribute("tabindex",1);var let_result1470 = M0.values();canvas957.setAttribute("style","outline: none");var let_result1471 = M0.values();this956.__canvas = canvas957;var let_result1472 = M0.values();this956.__context = ctx958;var let_result1473 = M0.values();M2.document.body.appendChild(canvas957);var let_result1474 = M0.values();canvas957.focus();var let_result1475 = M0.values();this956.register_handlers();var let_result1476 = M0.values();var draw_handler959 = this956.__active_handlers["to-draw"];if (draw_handler959!==false) {var if_res1477 = M0.rvoid();} else {var if_res1477 = M0.error($rjs_core.PrimitiveSymbol.make("big-bang"),$rjs_core.UString.make("to-draw handle not provided"));}if_res1477;var let_result1478 = M0.values();var img960 = draw_handler959.callback(this956.world);canvas957.width = img960.width;canvas957.height = img960.height;this956.change_world(this956.world);return this956;};BigBang.prototype.register_handlers = function() {var this961 = this;var active_handlers962 = this961.__active_handlers;var loop963 = function(_handlers9641506) {lambda_start1505:while (true){let handlers964 = _handlers9641506;if (M0.pair_p(handlers964)!==false) {var h965 = M0.car(handlers964)(this961);h965.register();active_handlers962[h965.name] = h965;_handlers9641506 = M0.cdr(handlers964);continue lambda_start1505;} else {return M0.rvoid();}}};return loop963(this961.handlers);};BigBang.prototype.deregister_handlers = function() {var this966 = this;var active_handlers967 = this966.__active_handlers;return Object.keys(active_handlers967).forEach(function(key968) {var h969 = active_handlers967[key968];h969.deregister();active_handlers967[h969.name] = undefined;return null;});};BigBang.prototype.start = function() {var this970 = this;this970.__stopped = false;this970.queue_event({'type':"to-draw"});return this970.process_events();};BigBang.prototype.stop = function() {var this971 = this;this971.clear_event_queue();this971.__stopped = true;this971.__idle = true;this971.deregister_handlers();this971.__active_handlers = {};this971.handlers = $rjs_core.Pair.EMPTY;return null;};BigBang.prototype.clear_event_queue = function() {var this972 = this;return this972.__events.splice(0,this972.__events.length);};BigBang.prototype.queue_event = function(e973) {var this974 = this;this974.__events.push(e973);if (this974.__idle!==false) {var self975 = this974;return window.requestAnimationFrame(function() {return self975.process_events();});} else {return M0.rvoid();}};BigBang.prototype.change_world = function(new_world976) {var this977 = this;var listeners978 = this977.__world_change_listeners;var loop979 = function(_i9801516) {lambda_start1515:while (true){let i980 = _i9801516;if (M0.__lt_(i980,listeners978.length)!==false) {var listener981 = listeners978[i980];listener981(new_world976);_i9801516 = M0.add1(i980);continue lambda_start1515;} else {return M0.rvoid();}}};loop979(0);this977.world = new_world976;return null;};BigBang.prototype.add_world_change_listener = function(cb982) {var this983 = this;return this983.__world_change_listeners.push(cb982);};BigBang.prototype.remove_world_change_listener = function(cb984) {var this985 = this;var index986 = this985.__world_change_listeners.indexOf(cb984);return this985.__world_change_listeners.splice(index986,1);};BigBang.prototype.process_events = function() {var this987 = this;var events988 = this987.__events;this987.__idle = false;var loop989 = function(_world_changed_p9901521) {lambda_start1520:while (true){let world_changed_p990 = _world_changed_p9901521;if (M0.__gt_(events988.length,0)!==false) {var evt991 = events988.shift();var handler992 = this987.__active_handlers[evt991.type];if (M0.equal_p(evt991.type,"raw")!==false) {var if_res1483 = evt991.invoke(this987.world,evt991);} else {if (handler992!==false) {var if_res1482 = handler992.invoke(this987.world,evt991);} else {var if_res1482 = M2.console.warn($rjs_core.UString.make("ignoring unknown/unregistered event type: "),evt991);}var if_res1483 = if_res1482;}var changed_p993 = if_res1483;var or_part994 = world_changed_p990;if (or_part994!==false) {var if_res1484 = or_part994;} else {var if_res1484 = changed_p993;}_world_changed_p9901521 = if_res1484;continue lambda_start1520;} else {if (world_changed_p990!==false) {var if_res1485 = M0.not(this987.__stopped);} else {var if_res1485 = false;}if (if_res1485!==false) {this987.queue_event({'type':"to-draw"});_world_changed_p9901521 = false;continue lambda_start1520;} else {return M0.rvoid();}}}};loop989(false);this987.__idle = true;return null;};var to_draw = function(cb995) {return function(bb996) {var on_tick_evt997 = {'type':"to-draw"};return {'name':"to-draw",'register':function() {return M0.rvoid();},'deregister':function() {return M0.rvoid();},'callback':cb995,'invoke':function(world998, evt999) {var ctx1000 = bb996.__context;var img1001 = cb995(bb996.world);var height1002 = img1001.height;var width1003 = img1001.width;ctx1000.clearRect(0,0,width1003,height1002);img1001.render(ctx1000,width1003/2,height1002/2);return false;}};};};var on_tick = function(cb1004, rate1005) {return function(bb1006) {var on_tick_evt1007 = {'type':"on-tick"};return {'name':"on-tick",'register':function() {var this1008 = this;bb1006.queue_event(on_tick_evt1007);if (rate1005!==false) {rate1005 = 1000*rate1005;return null;} else {rate1005 = bb1006.interval;return null;}},'deregister':function() {var this1009 = this;var last_cb1010 = this1009.last_cb;if (last_cb1010!==false) {return window.clearTimeout(last_cb1010);} else {return M0.rvoid();}},'invoke':function(world1011, _1012) {var this1013 = this;bb1006.change_world(cb1004(world1011));this1013.last_cb = setTimeout(function() {return bb1006.queue_event(on_tick_evt1007);},rate1005);return true;}};};};var on_mouse = function(cb1014) {return function(bb1015) {return {'name':"on-mouse",'listeners':{},'register':function() {var this1016 = this;var canvas1017 = bb1015.__canvas;var make_listener1018 = function(r_evt_name1019) {return function(evt1020) {var posn1021 = canvas_posn_δ(canvas1017,evt1020);return bb1015.queue_event({'type':"on-mouse",'evt':M1.js_string__gt_string(r_evt_name1019),'x':posn1021.x,'y':posn1021.y});};};var register_listener1022 = function(evt_name1023, r_evt_name1024) {var cb1025 = make_listener1018(r_evt_name1024);canvas1017.addEventListener(evt_name1023,cb1025);this1016.listeners[evt_name1023] = cb1025;return null;};register_listener1022("mousemove","move");register_listener1022("mousedown","button-down");register_listener1022("mouseup","button-up");register_listener1022("mouseout","leave");register_listener1022("mouseover","enter");return register_listener1022("drag","drag");},'deregister':function() {var this1026 = this;var remove_listener1027 = function(evt_name1028) {var cb1029 = this1026.listeners[evt_name1028];return bb1015.__canvas.removeEventListener(evt_name1028,cb1029);};remove_listener1027("mousemove");remove_listener1027("mousedown");remove_listener1027("mouseup");remove_listener1027("mouseout");remove_listener1027("mouseover");return remove_listener1027("drag");},'invoke':function(world1030, evt1031) {var new_world1032 = cb1014(world1030,evt1031.x,evt1031.y,evt1031.evt);bb1015.change_world(new_world1032);return true;}};};};var on_key = function(cb1033) {return function(bb1034) {return {'name':"on-key",'register':function() {var this1035 = this;var canvas1036 = bb1034.__canvas;this1035.listener = function(evt1037) {evt1037.preventDefault();evt1037.stopPropagation();return bb1034.queue_event({'type':"on-key",'key':key_event__gt_key_name(evt1037)});};return canvas1036.addEventListener("keydown",this1035.listener);},'deregister':function() {var this1038 = this;bb1034.__canvas.removeEventListener("keydown",this1038.listener);this1038.listener = undefined;return null;},'invoke':function(world1039, evt1040) {var new_world1041 = cb1033(world1039,evt1040.key);bb1034.change_world(new_world1041);return true;}};};};var on_release = function(cb1042) {return function(bb1043) {return {'name':"on-release",'register':function() {var this1044 = this;var canvas1045 = bb1043.__canvas;this1044.listener = function(evt1046) {evt1046.preventDefault();evt1046.stopPropagation();return bb1043.queue_event({'type':"on-release",'key':key_event__gt_key_name(evt1046)});};return canvas1045.addEventListener("keyup",this1044.listener);},'deregister':function() {var this1047 = this;bb1043.__canvas.removeEventListener("keyup",this1047.listener);this1047.listener = undefined;return null;},'invoke':function(world1048, evt1049) {var new_world1050 = cb1042(world1048,evt1049.key);bb1043.change_world(new_world1050);return true;}};};};var stop_when1051 = function(last_world_p21052, last_picture11053) {var last_world_p1054 = last_world_p21052;if (false!==false) {var if_res1490 = false;} else {var if_res1490 = last_picture11053;}var last_picture1055 = if_res1490;return function(bb1056) {return {'name':"stop-when",'predicate':last_world_p1054,'lastpicture':last_picture1055,'register':function() {var this1057 = this;return bb1056.add_world_change_listener(this1057.invoke);},'deregister':function() {var this1058 = this;return bb1056.remove_world_change_listener(this1058.invoke);},'invoke':function(w1059) {if (last_world_p1054(w1059)!==false) {bb1056.stop();if (last_picture1055!==false) {var handler1060 = to_draw(last_picture1055)(bb1056);return bb1056.queue_event({'type':"raw",'invoke':handler1060.invoke});} else {return M0.rvoid();}} else {return M0.rvoid();}}};};};var cl1493 = function(last_world_p1061) {return stop_when1051(last_world_p1061,false);};var cl1494 = function(last_world_p1062, last_picture11063) {return stop_when1051(last_world_p1062,last_picture11063);};var stop_when = $rjs_core.attachProcedureArity(function() {var fixed_lam1495 = {'1':cl1493,'2':cl1494}[arguments.length];if (fixed_lam1495!==undefined) {return fixed_lam1495.apply(null,arguments);} else {return M0.error($rjs_core.UString.make("case-lambda: invalid case"));}},[1,2]);var key_table = {'Backspace':$rjs_core.UString.make("\b"),'Enter':$rjs_core.UString.make("\r"),'Tab':$rjs_core.UString.make("\t"),'ArrowLeft':$rjs_core.UString.make("left"),'ArrowRight':$rjs_core.UString.make("right"),'ArrowDown':$rjs_core.UString.make("down"),'ArrowUp':$rjs_core.UString.make("up"),'Shift':$rjs_core.UString.make("shift"),'Control':$rjs_core.UString.make("control"),'ControlRight':$rjs_core.UString.make("rcontrol"),'ControlLeft':$rjs_core.UString.make("control"),'ShiftRight':$rjs_core.UString.make("rshift"),'ShiftLeft':$rjs_core.UString.make("shift"),'Escape':$rjs_core.UString.make("escape"),'Home':$rjs_core.UString.make("home"),'End':$rjs_core.UString.make("end"),'Insert':$rjs_core.UString.make("insert"),'Delete':$rjs_core.UString.make("\u007F"),'Pause':$rjs_core.UString.make("pause"),'NumLock':$rjs_core.UString.make("numlock"),'F1':$rjs_core.UString.make("f1"),'F2':$rjs_core.UString.make("f2"),'F3':$rjs_core.UString.make("f3"),'F4':$rjs_core.UString.make("f4"),'F5':$rjs_core.UString.make("f5"),'F6':$rjs_core.UString.make("f6"),'F7':$rjs_core.UString.make("f7"),'F8':$rjs_core.UString.make("f8"),'F9':$rjs_core.UString.make("f9"),'F10':$rjs_core.UString.make("f10"),'F11':$rjs_core.UString.make("f11"),'F12':$rjs_core.UString.make("f12")};var key_event__gt_key_name = function(e1064) {var k1065 = e1064.key;var or_part1067 = k1065==="Shift";if (or_part1067!==false) {var if_res1497 = or_part1067;} else {var or_part1068 = k1065==="Control";if (or_part1068!==false) {var if_res1496 = or_part1068;} else {var if_res1496 = k1065==="Alt";}var if_res1497 = if_res1496;}if (if_res1497!==false) {var if_res1498 = e1064.code;} else {var if_res1498 = k1065;}var code1066 = if_res1498;var key_table_code1069 = key_table[code1066];if (M0.void_p(key_table_code1069)!==false) {return M1.js_string__gt_string(code1066);} else {return key_table_code1069;}};var canvas_posn_δ = function(canvas1070, evt1071) {var rect1072 = canvas1070.getBoundingClientRect();return {'x':evt1071.clientX-rect1072.left,'y':evt1071.clientY-rect1072.top};};var key_eq__p = function(k11073, k21074) {return M0.equal_p(k11073,k21074);};var mouse_eq__p = function(m11075, m21076) {return M0.equal_p(m11075,m21076);};var __rjs_quoted__ = {};__rjs_quoted__.key_event__gt_key_name = key_event__gt_key_name;export { __rjs_quoted__,mouse_eq__p,key_eq__p,big_bang,stop_when,to_draw,on_release,on_key,on_tick,on_mouse };